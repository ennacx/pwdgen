<html lang="ja" class="h-100">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="robots" content="index,follow" />

    <title>パスワード生成</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>

    <script src="pwd_gen.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" crossorigin="anonymous" />

    <link rel="stylesheet" href="style.css" />

    <link href="favicon.ico" type="image/x-icon" rel="icon">
    <link href="favicon.ico" type="image/x-icon" rel="shortcut icon">

    <script>
        $(() => {
			const $slider = $('input[name="pwd_len_slider"]');
			const $len_box = $('input[name="pwd_len_input"]');
			const $use_type_box = $('input[name="use_type"]');
			const $ignore_symbol_box = $('input[name="ignore_symbols"]');

	        const $al_u_chk = $('input#alpha_u');
	        const $al_l_chk = $('input#alpha_l');
	        const $num_chk  = $('input#num');
	        const $sym_chk  = $('input#symbol');
	        const $hex_chk  = $('input#hex');

			const $unq_chk  = $('input#unique');
	        const $mis_chk  = $('input#mislead');

			const $symbol_info = $('#symbol-info');

			const $algo_err = $('.algo-err-msg');

			const $generate_btn = $('button[name="gen"]');
			const $bulk_generate_btn = $('button.bulk-gen');

	        const $validation_error = $('div#validation-error');
	        const $generate_result = $('div#generate-result');
	        const $bulk_generate_result = $('div#bulk-generate-result');
			const $bulk_textarea = $bulk_generate_result.find('textarea[name="bulk_password"]');

			const $password_copy_btn = $('button[name="password_copy"]');

			const anim_duration = 100;

			$slider.attr('min', PWD_LEN_MIN);
			$slider.attr('max', PWD_LEN_MAX);
	        $len_box.attr('min', PWD_LEN_MIN);
	        $len_box.attr('max', PWD_LEN_MAX);

	        if(!window.crypto || typeof window.crypto.getRandomValues !== 'function'){
		        $('input[name="algorithm"]').prop('checked', false);
		        $('input[name="algorithm"][value="crypt"]').prop('disabled', true);
		        $('input[name="algorithm"][value="math"]').prop('checked', true);

		        $algo_err.show(anim_duration);
	        }

			$('#symbol-samples').text(SYMBOL);
			$('#mislead-samples').text(MISLEAD_SYMBOLS);

	        $use_type_box.val(OPTION.use_type);

			const changeSymbolCheck = () => {
				if($sym_chk.prop('checked')){
					$symbol_info.show(anim_duration);
                } else{
					$symbol_info.hide(anim_duration);
                }
            };
	        $sym_chk.change(changeSymbolCheck);

			$('.default-check').change(function(){
				if($(this).prop('checked')){
					$('.hex-check').prop('checked', false);

					$use_type_box.val('default');
				}
            });
			$('.hex-check').change(function(){
				if($(this).prop('checked')){
					$('.default-check').prop('checked', false);
					$symbol_info.hide();

					$mis_chk.prop('checked', false).prop('disabled', true);

					$use_type_box.val('hex');
				} else{
					$al_u_chk.prop('checked', true);
					$al_l_chk.prop('checked', true);
					$num_chk.prop('checked', true);

					$mis_chk.prop('disabled', false);

					$use_type_box.val('default');
                }
            });

			const set_option = () => {

				const opt = OPTION;

				opt.length   = parseInt($len_box.val());
				opt.use_type = $use_type_box.val();

				opt.alpha_u = $al_u_chk.prop('checked');
				opt.alpha_l = $al_l_chk.prop('checked');
				opt.numeric = $num_chk.prop('checked');
				opt.symbol  = $sym_chk.prop('checked');
				opt.hex     = $hex_chk.prop('checked');

				opt.unique  = $unq_chk.prop('checked');
				opt.mislead = $mis_chk.prop('checked');

				opt.algorithm = $('input[name="algorithm"]:checked').val();

				opt.ignore_symbols = $ignore_symbol_box.val();

				return opt;
            };

			let password;
	        $generate_btn.click(() => {
		        $validation_error.hide().empty();

				$bulk_generate_result.hide();
                $bulk_textarea.text('');
				$bulk_textarea.val('');

		        const opt = set_option();

		        const validate = validation(opt);
		        if(validate !== null){
			        $generate_result.hide().empty();

			        $validation_error
                        .append(`<div class="alert alert-danger">${validate}</div>`)
                        .show(anim_duration);
		        } else{
					password = password_generate(opt);
					if(password !== null){
						$generate_result.find('div#generate-password').text(password);
						$generate_result.show(anim_duration);
                    } else{
						$generate_result.hide();
                    }
                }
	        });

	        $bulk_generate_btn.click(function(){
		        $validation_error.hide().empty();
				$generate_result.hide();

		        const opt = set_option();

		        const validate = validation(opt);
		        if(validate !== null){
			        $generate_result.hide().empty();

			        $validation_error
				        .append(`<div class="alert alert-danger">${validate}</div>`)
				        .show(anim_duration);
		        } else{
			        const passwords = bulk_password_generate(opt, parseInt($(this).val()));
			        const temp = (passwords !== null) ? passwords.join("\n") : '';

                    $bulk_textarea.text(temp);
                    $bulk_textarea.val(temp);

			        $bulk_generate_result.show(anim_duration);
		        }
            });

			if(!navigator.clipboard){
				$password_copy_btn.hide();
            }
			$password_copy_btn.click(function(){
				const $label = $(this).find('i');

				navigator.clipboard.writeText(password).then(
					() => {
						$label.removeClass('bi-copy').addClass('bi-check2');
						setTimeout(() => {
							$label.removeClass('bi-check2').addClass('bi-copy');
						}, 3000);
					},
					() => {
						alert("コピーに失敗しました。");
					});
            });

	        $len_box.on('keyup change', function(e){
				const val = $(this).val();
				let newval = (val === '' || isNaN(val)) ? PWD_LEN_MIN : parseInt(val);
				if(newval < PWD_LEN_MIN)
					newval = PWD_LEN_MIN;
				else if(newval > PWD_LEN_MAX)
					newval = PWD_LEN_MAX;

		        $slider.val(newval);
		        $len_box.val(newval);
            });

			const symbols     = SYMBOL.split('');
			const symbols_zen = SYMBOL_ZEN.split('');

	        const ignore_symbol_regexp_pattern = `[^${SYMBOL.replace('-', '\\-').replace(']', '\\]')}]`;
	        $ignore_symbol_box.on('change', function(e){
				const val = $(this).val();
				const temp = [];
				for(let i in val){
					const char = val[i];
					const index = symbols_zen.indexOf(char);

					temp.push((index >= 0) ? symbols[index] : char);
                }

				$(this).val((temp.length > 0) ? array_unique(temp).join('').replace(new RegExp(ignore_symbol_regexp_pattern, 'g'), '') : '');
            });

	        const updateInterestRate = () => {
		        $len_box.val($slider.val());
	        };

	        const initializeSlider = () => {
		        updateInterestRate();
		        $slider.on('input', updateInterestRate)
	        };

	        initializeSlider();
        })
    </script>
</head>

<body>
    <div class="container-fluid">
        <h1>パスワード生成</h1>

        <label for="pwd_len_slider" class="form-label">文字の長さを指定</label>
        <input type="range" name="pwd_len_slider" step="1" value="16" id="pwd_len_slider" class="form-range">
        <div class="input-group">
            <input type="number" name="pwd_len_input" id="pwd_len_input" class="form-control small" />
            <span class="input-group-text">文字</span>
        </div>

        <div class="card mt-4">
            <div class="card-header">文字種</div>
            <div class="card-body">
                <div class="d-flex">
                    <div class="form-check form-switch">
                        <input type="checkbox" id="alpha_u" class="form-check-input default-check" role="switch" checked />
                        <label class="form-check-label" for="alpha_u">大文字</label>
                    </div>
                    <div class="form-check form-switch ms-4">
                        <input type="checkbox" id="alpha_l" class="form-check-input default-check" role="switch" checked />
                        <label class="form-check-label" for="alpha_l">小文字</label>
                    </div>
                    <div class="form-check form-switch ms-4">
                        <input type="checkbox" id="num" class="form-check-input default-check" role="switch" checked />
                        <label class="form-check-label" for="num">数字</label>
                    </div>
                    <div class="form-check form-switch ms-4">
                        <input type="checkbox" id="symbol" class="form-check-input default-check" role="switch" />
                        <label class="form-check-label" for="symbol">記号</label>
                    </div>

                    <input type="hidden" name="use_type" />
                </div>
                <div id="symbol-info">
                    <p>登録済み記号一覧</p>
                    <div id="symbol-samples"></div>
                    <div class="row ignore-symbol-input">
                        <div class="col-4">
                            <label for="ignore_symbols" class="col-form-label">使用しない記号があれば入力</label>
                        </div>
                        <div class="col-8">
                            <input type="text" name="ignore_symbols" id="ignore_symbols" class="form-control" />
                        </div>
                    </div>
                </div>
                <div class="d-flex mt-2">
                    <div class="form-check form-switch">
                        <input type="checkbox" id="hex" class="form-check-input hex-check" role="switch" />
                        <label class="form-check-label" for="hex">16進数のみ</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">オプション</div>
            <div class="card-body">
                <div class="d-flex">
                    <div class="form-check form-switch">
                        <input type="checkbox" id="unique" class="form-check-input" role="switch" />
                        <label class="form-check-label" for="unique">文字は重複させない</label>
                    </div>
                </div>
                <div class="d-flex mt-2">
                    <div class="form-check form-switch">
                        <input type="checkbox" id="mislead" class="form-check-input" role="switch" />
                        <label class="form-check-label" for="mislead">
                            紛らわしい文字種は使用しない
                            <span id="mislead-samples"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">アルゴリズム</div>
            <div class="card-body">
                <div class="form-check form-check-inline">
                    <input type="radio" name="algorithm" value="crypt" id="algorithm_crypt" class="form-check-input" checked>
                    <label for="algorithm_crypt" class="form-check-label">Crypt</label>
                </div>
                <div class="form-check form-check-inline">
                    <input type="radio" name="algorithm" value="math" id="algorithm_math" class="form-check-input">
                    <label for="algorithm_math" class="form-check-label">Math<span class="error">&nbsp;(非推奨)</span></label>
                </div>
                <div class="error algo-err-msg">ご使用のブラウザではCrypt対応していないため、Mathを利用した乱数を用います。</div>
            </div>
        </div>

        <div class="d-grid gap-2 mt-3">
            <button type="button" name="gen" class="btn btn-success">パスワード生成</button>
        </div>

        <div id="validation-error"></div>
        <div id="generate-result">
            <div class="alert alert-success w-100">
                <div class="d-flex">
                    <div id="generate-password"></div>
                    <button name="password_copy" class="btn btn-sm btn-outline-success ms-auto"><i class="bi bi-copy"></i></button>
                </div>
            </div>
        </div>

        <div class="d-grid gap-2 mt-3">
            <button type="button" value="100" class="bulk-gen btn btn-sm btn-outline-primary mt-4">100個同時パスワード生成</button>
            <button type="button" value="1000" class="bulk-gen btn btn-sm btn-outline-primary">1,000個同時パスワード生成</button>
            <button type="button" value="10000" class="bulk-gen btn btn-sm btn-outline-primary">10,000個同時パスワード生成</button>
        </div>

        <div id="bulk-generate-result">
            <textarea name="bulk_password" class="form-control" rows="10"></textarea>
        </div>
    </div>
</body>
</html>